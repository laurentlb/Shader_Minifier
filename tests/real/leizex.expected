; File generated with 
; http://www.ctrl-alt-test.fr

_leizex_frag:
	db '#extension GL_EXT_gpu_shader4:enable', 10, ''
	db 'uniform vec2 resolution;'
	db 'uniform float time;'
	db 'uniform sampler2D tex0,tex1,tex2,tex3;'
	db 'float coolfFunc3d2(int n)'
	db '{'
	db   'return n=n<<13^n,n=n*(n*n*15731+789221)+1376312589&2147483647,float(n);'
	db '}'
	db 'float noise3f(vec3 x,int sem)'
	db '{'
	db   'ivec3 ip=ivec3(floor(x));'
	db   'vec3 f=fract(x);'
	db   'f=f*f*(3.-2.*f);'
	db   'int n=ip.x+ip.y*57+113*ip.z+sem;'
	db   'float res=mix(mix(mix(coolfFunc3d2(n),coolfFunc3d2(n+1),f.x),mix(coolfFunc3d2(n+57),coolfFunc3d2(n+58),f.x),f.y),mix(mix(coolfFunc3d2(n+113),coolfFunc3d2(n+114),f.x),mix(coolfFunc3d2(n+170),coolfFunc3d2(n+171),f.x),f.y),f.z);'
	db   'return 1.-res*(1./1073741824.);'
	db '}'
	db 'vec2 celular(vec3 x)'
	db '{'
	db   'ivec3 ip=ivec3(floor(x));'
	db   'vec3 f=fract(x);'
	db   'vec2 dmin=vec2(1.,1.);'
	db   'for(int k=-1;k<=1;k++)'
	db     'for(int j=-1;j<=1;j++)'
	db       'for(int i=-1;i<=1;i++)'
	db         '{'
	db           'int nn=ip.x+i+57*(ip.y+j)+113*(ip.z+k);'
	db           'vec3 di=vec3(float(i),float(j),float(k))-f+vec3(coolfFunc3d2(nn),coolfFunc3d2(nn+1217),coolfFunc3d2(nn+2513))/2147483647.;'
	db           'float d2=dot(di,di);'
	db           'if(d2<dmin.x)'
	db             'dmin.y=dmin.x,dmin.x=d2;'
	db           'else'
	db             ' if(d2<dmin.y)'
	db               'dmin.y=d2;'
	db         '}'
	db   'return.25*sqrt(dmin);'
	db '}'
	db 'float fbm(vec3 x)'
	db '{'
	db   'return.5*noise3f(x,0)+.25*noise3f(x*2.,0)+.125*noise3f(x*4.,0)+.0625*noise3f(x*8.,0);'
	db '}'
	db 'float map(vec3 x,out float ao)'
	db '{'
	db   'vec3 d=mod(vec3(1024.)+x,1.)-.5;'
	db   'float dis=sqrt(dot(d,d))-.09,disp=noise3f(4.*x,0);'
	db   'dis+=.8*disp;'
	db   'ao=clamp(-1.5*disp,0.,1.);'
	db   'vec2 cel=celular(16.*x);'
	db   'float disp2=clamp(cel[1]-cel[0],0.,1.);'
	db   'dis-=disp2;'
	db   'ao*=clamp(disp2*12.,0.,1.);'
	db   'return dis;'
	db '}'
	db 'vec3 calcNormal(vec3 pos)'
	db '{'
	db   'float kk,eps=2e-4;'
	db   'vec3 nor=vec3(map(pos+vec3(eps,0.,0.),kk)-map(pos-vec3(eps,0.,0.),kk),map(pos+vec3(0.,eps,0.),kk)-map(pos-vec3(0.,eps,0.),kk),map(pos+vec3(0.,0.,eps),kk)-map(pos-vec3(0.,0.,eps),kk));'
	db   'return normalize(nor);'
	db '}'
	db 'void generateRay(out vec3 rayDir,out vec3 rayPos,vec2 p,float ftime)'
	db '{'
	db   'vec2 s=p;'
	db   'float r2=s.x*s.x*.32+s.y*s.y;'
	db   'vec2 d=s*(7.-sqrt(37.5-11.5*r2))/(r2+1.);'
	db   'vec3 rayTar=vec3(0.,1.5,2.);'
	db   'rayPos=rayTar+vec3(-sin(6.2831853*ftime/20.),.75*cos(6.2831853*ftime/20.+.5),-cos(6.2831853*ftime/20.));'
	db   'rayTar+=.075*vec3(noise3f(vec3(2.*ftime,0.,.5),0),noise3f(vec3(2.*ftime,.1,.4),7),noise3f(vec3(2.*ftime,.2,.3),9));'
	db   'float roll=.1*noise3f(vec3(2.*ftime,0.,0.),13);'
	db   'vec3 up=vec3(0.,cos(roll),sin(roll)),dd=normalize(rayTar-rayPos),rr=normalize(cross(dd,up)),uu=normalize(cross(rr,dd));'
	db   'rayDir=normalize(d.x*rr+d.y*uu+dd);'
	db '}'
	db 'vec3 addbump(vec3 nor,float bumpa,vec3 x)'
	db '{'
	db   'float ke=5e-4,kk=fbm(256.*x);'
	db   'vec3 xnor=vec3(fbm(256.*(x+vec3(ke,0.,0.)))-kk,fbm(256.*(x+vec3(0.,ke,0.)))-kk,fbm(256.*(x+vec3(0.,0.,ke)))-kk);'
	db   'return normalize(nor+bumpa*xnor);'
	db '}'
	db 'void main()'
	db '{'
	db   'vec2 p=-1.+2.*gl_FragCoord.xy/resolution.xy;'
	db   'vec3 ro,rd;'
	db   'generateRay(rd,ro,p,time);'
	db   'float t,ao;'
	db   'vec3 nor,pos;'
	db   'for(t=.1;t<5.;)'
	db     '{'
	db       'pos=ro+t*rd;'
	db       'float h=map(pos,ao);'
	db       'if(h<.001)'
	db         'break;'
	db       't+=h*.12;'
	db     '}'
	db   'nor=calcNormal(pos);'
	db   'vec3 col=vec3(1.+.5*fbm(96.*pos)),xnor=addbump(nor,1.,.25*pos),lig=vec3(.8,.5,-.1);'
	db   'float dif=clamp(dot(xnor,lig),0.,1.);'
	db   'vec3 ref=vec3(.5,.55,.6)+vec3(.6,.5,.3)*dif*3.;'
	db   'col=col*ref*ao;'
	db   'col=col/(1.+t)+vec3(1.06,1.14,1.)*(1.-exp2(-.25*t));'
	db   'col=(col*col+col)*.5;'
	db   'col=clamp(col*vec3(1.,1.2,1.),0.,1.);'
	db   'col*=.5+.5*(1.-p.x)*(1.+p.x);'
	db   'gl_FragColor=vec4(col,1.);'
	db '}', 0
